<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <base target="_top">
    <!-- Google Fonts: Teko for headings -->
    <link href="https://fonts.googleapis.com/css2?family=Teko:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome Script -->
    <script src="https://kit.fontawesome.com/ec27db2507.js" crossorigin="anonymous"></script>
    <style>
      /* CSS Variables */
      :root {
        --teal-color: #39908b; /* Primary teal color */
        --white: #ffffff;       /* White color */
      }

      /* Reset & Global Styles */
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      /* Global font and background */
      body {
        font-family: 'Proxima Nova', sans-serif;
        background-color: #f5f7fa;
        padding: 20px;
        color: var(--teal-color);
        line-height: 1.6;
      }

      /* Container styling */
      .container {
        max-width: 800px;
        margin: 0 auto;
        background: var(--white);
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        animation: fadeIn 1s ease-out;
      }

      /* Headings: Use Teko font */
      h1, h2 {
        font-family: 'Teko', sans-serif;
        text-align: center;
        margin-bottom: 20px;
        color: var(--teal-color);
      }
      h1 i {
        margin-right: 10px;
      }

      /* Introductory text */
      p.intro {
        text-align: center;
        margin-bottom: 20px;
        font-size: 1.2em;
      }

      /* Company logo styling */
      .company-logo {
        display: block;
        max-width: 150px;
        margin: 0 auto 20px auto;
      }

      /* Form styling */
      form {
        margin: 20px 0;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-size: 1.1em;
        color: var(--teal-color);
      }
      input[type="text"],
      select,
      textarea {
        width: 100%;
        padding: 15px;
        font-size: 1.1em;
        font-family: 'Proxima Nova', sans-serif;
        margin-bottom: 15px;
        background: var(--white);
        border: 2px solid #ddd;
        border-radius: 5px;
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
        color: var(--teal-color);
      }
      input[type="text"]::placeholder,
      textarea::placeholder {
        color: #999;
      }
      input[type="text"]:focus,
      select:focus,
      textarea:focus {
        border-color: var(--teal-color);
        box-shadow: 0 0 8px rgba(57,144,139,0.3);
        outline: none;
      }

      /* Submit button styling */
      button.submit-btn {
        display: block;
        width: 100%;
        padding: 15px;
        font-size: 1.2em;
        font-family: 'Proxima Nova', sans-serif;
        background-color: var(--white);
        color: var(--teal-color);
        border: 2px solid var(--teal-color);
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s ease, color 0.3s ease, transform 0.2s ease;
      }
      button.submit-btn i {
        margin-right: 8px;
      }
      button.submit-btn:hover {
        background-color: var(--teal-color);
        color: var(--white);
        transform: scale(1.02);
      }

      /* Loading spinner styling */
      .loading-spinner {
        display: none;
        text-align: center;
        margin: 20px 0;
      }
      .spinner {
        border: 8px solid #f3f3f3;
        border-top: 8px solid var(--teal-color);
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 2s linear infinite;
        margin: 0 auto;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      /* Tab styling */
      .tabs {
        display: flex;
        margin-bottom: 20px;
        border-bottom: 2px solid #ddd;
      }
      .tab {
        padding: 10px 20px;
        cursor: pointer;
        font-family: 'Teko', sans-serif;
        font-size: 1.3em;
        color: #999;
        transition: color 0.3s, border-bottom 0.3s;
      }
      .tab.active {
        color: var(--teal-color);
        border-bottom: 3px solid var(--teal-color);
        margin-bottom: -2px;
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
        animation: fadeIn 0.5s ease-out;
      }

      /* Data source selector */
      .data-source-selector {
        margin-bottom: 20px;
      }
      .data-source-option {
        display: inline-block;
        padding: 10px 15px;
        margin-right: 10px;
        margin-bottom: 10px;
        border: 2px solid #ddd;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      .data-source-option:hover {
        border-color: var(--teal-color);
      }
      .data-source-option.selected {
        background-color: var(--teal-color);
        color: var(--white);
        border-color: var(--teal-color);
      }
      .data-source-option i {
        margin-right: 5px;
      }

      /* Data source forms */
      .data-source-form {
        display: none;
        margin-top: 20px;
        padding: 20px;
        background-color: #f9f9f9;
        border-radius: 5px;
      }
      .data-source-form.active {
        display: block;
        animation: fadeIn 0.5s ease-out;
      }

      /* Fade-in animation */
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }

      /* Responsive adjustments */
      @media (max-width: 600px) {
        .container {
          padding: 20px;
        }
        input[type="text"],
        select,
        textarea,
        button.submit-btn {
          padding: 12px;
          font-size: 1em;
        }
        .tab {
          padding: 8px 12px;
          font-size: 1.1em;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Optional Company Logo -->
      <img src="https://cdn.prod.website-files.com/63f3e085b054e9e3120238f1/63f3e0ba605c2a218c60f27e_image%201.svg" alt="Company Logo" class="company-logo">

      <!-- Header with wand-magic icon -->
      <h1><i class="fa-solid fa-wand-magic"></i>Universal Data Transformer</h1>

      <p class="intro">Transform any data into professional slide presentations.</p>

      <div style="background-color: #f0f8ff; padding: 10px; border-radius: 5px; margin-bottom: 20px; border-left: 4px solid #39908b;">
        <p style="margin: 0;"><strong>Note:</strong> Templates should use <code>{{field}}</code> format for placeholders (e.g., <code>{{companyName}}</code>, <code>{{description}}</code>).</p>
        <p style="margin: 5px 0 0 0;"><strong>Image fields</strong> like <code>{{logo}}</code> or <code>{{companyImage}}</code> will be automatically detected and processed as images.</p>
      </div>

      <!-- Tabs -->
      <div class="tabs">
        <div class="tab active" data-tab="data-input">1. Data Input</div>
        <div class="tab" data-tab="template-selection">2. Template Selection</div>
        <div class="tab" data-tab="options">3. Options</div>
      </div>

      <!-- Tab Content -->
      <div class="tab-content active" id="data-input">
        <h2>Select Your Data Source</h2>

        <div class="data-source-selector">
          <div class="data-source-option selected" data-source="raw-text">
            <i class="fas fa-file-alt"></i> Paste Data
          </div>
          <div class="data-source-option" data-source="airtable">
            <i class="fas fa-table"></i> Airtable
          </div>
          <div class="data-source-option" data-source="google-sheets">
            <i class="fas fa-file-excel"></i> Google Sheets
          </div>
        </div>

        <!-- Raw Text Input Form -->
        <div class="data-source-form active" id="raw-text-form">
          <label for="rawData">Paste your data (CSV, JSON, or any tabular data):</label>
          <textarea id="rawData" name="rawData" rows="8" placeholder="Paste your data here..." required></textarea>
        </div>

        <!-- Airtable Input Form -->
        <div class="data-source-form" id="airtable-form">
          <label for="airtableUrl">Airtable URL:</label>
          <input type="text" id="airtableUrl" name="airtableUrl" placeholder="'Ready for preso' must be inside as a clickbox field!!!" />
        </div>

        <!-- Google Sheets Input Form -->
        <div class="data-source-form" id="google-sheets-form">
          <label for="sheetsUrl">Google Sheets URL:</label>
          <input type="text" id="sheetsUrl" name="sheetsUrl" placeholder="Enter the URL of your Google Sheet" />

          <label for="sheetName">Sheet Name (optional):</label>
          <input type="text" id="sheetName" name="sheetName" placeholder="Leave blank to use the first sheet" />
        </div>

        <button type="button" class="submit-btn" onclick="nextTab('template-selection')">
          <i class="fas fa-arrow-right"></i> Next: Select Template
        </button>
      </div>

      <div class="tab-content" id="template-selection">
        <h2>Select Your Template</h2>

        <!-- Template Selection Dropdown -->
        <div id="templateSection">
          <label for="templateDropdown">Select Template File:</label>
          <select id="templateDropdown" name="templateDropdown" onchange="onTemplateChange()">
            <option value="">-- Loading Templates... --</option>
          </select>
        </div>

        <!-- Final Deck URL -->
        <div id="finalDeckField">
          <label for="finalDeckUrl">Final Deck URL:</label>
          <input type="text" id="finalDeckUrl" name="finalDeckUrl" placeholder="This slide deck must provide edit access for anyone with the link!!!" required />
        </div>

        <!-- Hidden field for detected layout -->
        <input type="hidden" id="layout" name="layout" value="" />

        <!-- Hidden field: Template Deck URL (populated automatically) -->
        <input type="hidden" id="templateDeckUrl" name="templateDeckUrl" value="" />

        <!-- Template Conversion Helper -->
        <div style="margin: 20px 0; padding: 15px; background-color: #f9f9f9; border-radius: 5px; border: 1px dashed #ddd;">
          <p style="margin-top: 0;"><i class="fas fa-info-circle"></i> <strong>Template Helper:</strong> If your template uses different placeholder formats (like [FIELD], &lt;FIELD&gt;), you can convert them to the standard {{field}} format.</p>
          <button type="button" class="submit-btn" style="background-color: #f0f8ff; margin-top: 10px;" onclick="convertPlaceholders()">
            <i class="fas fa-magic"></i> Convert Template Placeholders
          </button>
        </div>

        <button type="button" class="submit-btn" onclick="nextTab('options')">
          <i class="fas fa-arrow-right"></i> Next: Options
        </button>
      </div>

      <div class="tab-content" id="options">
        <h2>Additional Options</h2>

        <label for="systemInstruction">Program-specific Details:</label>
        <textarea id="systemInstruction" name="systemInstruction" rows="4" placeholder='Enter any specific instructions or context for processing the data...' required></textarea>

        <!-- Submit Button -->
        <button type="button" class="submit-btn" onclick="submitForm()">
          <i class="fas fa-paper-plane"></i> Generate Slides
        </button>
      </div>

      <!-- Loading Spinner -->
      <div class="loading-spinner" id="loadingSpinner">
        <div class="spinner"></div>
        <p>Transforming your data into slides...</p>
      </div>
    </div>

    <script>
      // Tab navigation
      function nextTab(tabId) {
        // Validate current tab before proceeding
        if (!validateCurrentTab()) {
          return;
        }

        // Activate the next tab
        document.querySelectorAll('.tab').forEach(tab => {
          tab.classList.remove('active');
          if (tab.getAttribute('data-tab') === tabId) {
            tab.classList.add('active');
          }
        });

        document.querySelectorAll('.tab-content').forEach(content => {
          content.classList.remove('active');
          if (content.id === tabId) {
            content.classList.add('active');
          }
        });
      }

      // Validate the current tab
      function validateCurrentTab() {
        const activeTab = document.querySelector('.tab-content.active');

        if (activeTab.id === 'data-input') {
          const activeSourceForm = document.querySelector('.data-source-form.active');

          if (activeSourceForm.id === 'raw-text-form') {
            const rawData = document.getElementById('rawData').value.trim();
            if (!rawData) {
              alert('Please paste your data before proceeding.');
              return false;
            }
          } else if (activeSourceForm.id === 'airtable-form') {
            const airtableUrl = document.getElementById('airtableUrl').value.trim();
            if (!airtableUrl) {
              alert('Please enter your Airtable URL before proceeding.');
              return false;
            }
          } else if (activeSourceForm.id === 'google-sheets-form') {
            const sheetsUrl = document.getElementById('sheetsUrl').value.trim();
            if (!sheetsUrl) {
              alert('Please enter your Google Sheets URL before proceeding.');
              return false;
            }
          }
        } else if (activeTab.id === 'template-selection') {
          const templateDropdown = document.getElementById('templateDropdown');
          const finalDeckUrl = document.getElementById('finalDeckUrl').value.trim();

          if (templateDropdown.value === '') {
            alert('Please select a template before proceeding.');
            return false;
          }

          if (!finalDeckUrl) {
            alert('Please enter the final deck URL before proceeding.');
            return false;
          }
        }

        return true;
      }

      // Data source selection
      document.querySelectorAll('.data-source-option').forEach(option => {
        option.addEventListener('click', function() {
          // Update selected state
          document.querySelectorAll('.data-source-option').forEach(opt => {
            opt.classList.remove('selected');
          });
          this.classList.add('selected');

          // Show the corresponding form
          const sourceType = this.getAttribute('data-source');
          document.querySelectorAll('.data-source-form').forEach(form => {
            form.classList.remove('active');
          });
          document.getElementById(sourceType + '-form').classList.add('active');
        });
      });

      // This function extracts the folder ID from the gallery link URL.
      function getFolderIdFromGallery() {
        return "1eCjnDNHYDqskWYqPhJdlMTXiqio4TJkr"; // Default folder ID
      }

      // Load template files from the specified Drive folder on page load.
      function loadTemplateFiles() {
        var folderId = getFolderIdFromGallery();
        console.log("Loading templates from folder ID:", folderId);

        google.script.run
          .withSuccessHandler(function(files) {
            var dropdown = document.getElementById('templateDropdown');
            dropdown.innerHTML = "<option value=''>-- Select Template --</option>";
            files.forEach(function(file) {
              var option = document.createElement("option");
              option.value = file.url;
              option.text = file.name;
              dropdown.appendChild(option);
            });
            console.log("Loaded files:", files);
          })
          .withFailureHandler(function(error) {
            console.error("Error loading templates:", error);
            alert("Error loading templates: " + error);
          })
          .getTemplateFilesFromFolder(folderId);
      }

      // Call loadTemplateFiles() when the window loads.
      window.onload = function() {
        loadTemplateFiles();

        // Set up tab navigation
        document.querySelectorAll('.tab').forEach(tab => {
          tab.addEventListener('click', function() {
            nextTab(this.getAttribute('data-tab'));
          });
        });
      }

      // When a template file is selected, detect the layout from its name and populate hidden fields.
      function onTemplateChange() {
        var dropdown = document.getElementById('templateDropdown');
        var selectedUrl = dropdown.value;
        var selectedName = dropdown.options[dropdown.selectedIndex].text;
        var layout = "";
        // Detect 'single' or 'double' in the file name.
        if (selectedName.toLowerCase().includes("single")) {
          layout = "single";
        } else if (selectedName.toLowerCase().includes("double")) {
          layout = "double";
        }
        document.getElementById("layout").value = layout;
        document.getElementById("templateDeckUrl").value = selectedUrl;
      }

      // Function to convert placeholders in the template to the standard format
      function convertPlaceholders() {
        var templateDeckUrl = document.getElementById('templateDeckUrl').value;

        if (!templateDeckUrl) {
          alert("Please select a template first.");
          return;
        }

        // Show the loading spinner
        document.getElementById("loadingSpinner").style.display = "block";

        google.script.run
          .withSuccessHandler(function(response) {
            // Hide the loading spinner
            document.getElementById("loadingSpinner").style.display = "none";

            if (response.success) {
              alert("Success: " + response.message);
            } else {
              alert("Error: " + response.message);
            }
          })
          .withFailureHandler(function(error) {
            // Hide the loading spinner
            document.getElementById("loadingSpinner").style.display = "none";
            alert("Error: " + error);
          })
          .convertPlaceholdersToStandardFormat(templateDeckUrl);
      }

      // When the form is submitted, gather all data and send it to the server.
      function submitForm() {
        // Validate all inputs
        if (!validateCurrentTab()) {
          return;
        }

        // Show the loading spinner.
        document.getElementById("loadingSpinner").style.display = "block";

        // Get common parameters
        var layout = document.getElementById('layout').value;
        var templateDeckUrl = document.getElementById('templateDeckUrl').value;
        var finalDeckUrl = document.getElementById('finalDeckUrl').value;
        var systemInstruction = document.getElementById('systemInstruction').value;

        // Determine which data source is selected
        var selectedSource = document.querySelector('.data-source-option.selected').getAttribute('data-source');

        // Prepare the parameters object for the universal transformer
        var params = {
          useUniversalTransformer: true,
          layout: layout,
          systemInstruction: systemInstruction,
          templateInfo: {
            templateId: templateDeckUrl,
            finalDeckId: finalDeckUrl
          }
        };

        // Add data source specific parameters
        if (selectedSource === 'raw-text') {
          params.dataSource = {
            type: "raw_text",
            connectionInfo: {
              data: document.getElementById('rawData').value
            }
          };
        } else if (selectedSource === 'airtable') {
          var airtableUrl = document.getElementById('airtableUrl').value;
          params.dataSource = {
            type: "airtable",
            connectionInfo: {
              // The extractAirtableIds function will be called server-side
              airtableUrl: airtableUrl,
              filterFormula: "{Ready for preso} = 1"
            }
          };
        } else if (selectedSource === 'google-sheets') {
          var sheetsUrl = document.getElementById('sheetsUrl').value;
          var sheetName = document.getElementById('sheetName').value;
          params.dataSource = {
            type: "google_sheets",
            connectionInfo: {
              // The spreadsheet ID will be extracted server-side
              sheetsUrl: sheetsUrl,
              sheetName: sheetName
            }
          };
        }

        console.log("Submitting params:", params);

        google.script.run
          .withSuccessHandler(function(response) {
            // Hide the loading spinner.
            document.getElementById("loadingSpinner").style.display = "none";
            alert("Success: " + JSON.stringify(response));
          })
          .withFailureHandler(function(error) {
            // Hide the loading spinner.
            document.getElementById("loadingSpinner").style.display = "none";
            alert("Error: " + error);
          })
          .processData(params);
      }
    </script>
  </body>
</html>
